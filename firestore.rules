
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // دالة للتحقق مما إذا كان النظام في حالة إعداد أولى
    function isSetupInProgress() {
      return !exists(/databases/$(database)/documents/system/config);
    }

    // دالة مساعدة للتحقق من هوية السوبر أدمن
    function isSuperAdmin() {
      return request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin';
    }

    // قواعد تهيئة النظام
    match /system/config {
      allow read: if true;
      allow write: if isSetupInProgress() || isSuperAdmin();
    }

    // قواعد المحتوى العام والإعدادات
    match /content/{docId} {
      allow read: if true;
      allow write: if isSetupInProgress() || isSuperAdmin();
    }

    // إحصائيات النظام - السماح للعامة بتحديث عداد الزيارات فقط
    match /stats/global {
      allow read: if true;
      allow create, delete: if isSuperAdmin() || isSetupInProgress();
      allow update: if isSuperAdmin() || 
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['visitorCount']));
    }

    // قواعد المستخدمين
    match /users/{userId} {
      allow read: if (request.auth != null && request.auth.uid == userId) || 
                   (resource.data.role == 'Volunteer') ||
                   isSuperAdmin();
      allow write: if (request.auth != null && request.auth.uid == userId) || isSuperAdmin();
    }

    // البرامج والأنشطة
    match /programs/{docId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /activities/{docId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // طلبات المساعدة
    match /aid_requests/{docId} {
      allow create: if true;
      allow read, update, delete: if isSuperAdmin();
    }

    // رسائل التواصل
    match /contact_messages/{docId} {
      allow create: if true;
      allow read, delete: if isSuperAdmin();
    }
  }
}
